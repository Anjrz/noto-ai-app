<MainAppScreen>:
    MainContent:
        id: main_content

<Animated3DButton@Button>:
    scale: 1.0
    shadow_offset: 12
    shadow_blur: 36
    shadow_alpha: 0.28
    background_normal: ''
    background_color: 0,0,0,0
    padding: 22, 22
    font_size: 24
    color: 1, 1, 1, 1
    bold: True
    canvas.before:
        Color:
            rgba: 0, 0, 0, self.shadow_alpha
        RoundedRectangle:
            pos: self.x, self.y - self.shadow_offset
            size: self.width, self.height
            radius: [34]
        PushMatrix
        Scale:
            origin: self.center
            x: self.scale
            y: self.scale
            z: 1
        Color:
            rgba: (0.10, 0.45, 0.80, 1) if self.state == 'normal' else (0.08, 0.35, 0.65, 1)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [34]
        PopMatrix

    on_press:
        app.root.get_screen('main').ids.main_content.animate_button(self)
    on_release:
        app.root.get_screen('main').ids.main_content.animate_button_release(self)

<LoadingSpinner@BoxLayout>:
    orientation: 'horizontal'
    size_hint: None, None
    size: 54, 54
    opacity: 0
    canvas:
        Color:
            rgba: 0.2, 0.6, 0.86, 0.2
        Ellipse:
            pos: self.center_x-24, self.center_y-24
            size: 48, 48
    Image:
        source: 'assets/icons/spinner.gif'
        size_hint: None, None
        size: 48, 48
        pos_hint: {'center_x': 0.5, 'center_y': 0.5}
        anim_delay: 0.05

<MainContent>:
    bg_color: root.bg_color
    text_color: root.text_color
    accent_color: root.accent_color
    orientation: 'vertical'
    spacing: 0
    padding: 0
    canvas.before:
        Color:
            rgba: root.bg_color
        Rectangle:
            pos: self.pos
            size: self.size
        Color:
            rgba: root.accent_color
        Rectangle:
            pos: self.x, self.y + self.height/2
            size: self.width, self.height/2

    BoxLayout:
        orientation: 'vertical'
        size_hint: None, 1
        width: min(self.parent.width * 0.98, 900)
        pos_hint: {'center_x': 0.5, 'center_y': 0.5}
        padding: 40
        spacing: 32
        canvas.before:
            Color:
                rgba: root.bg_color
            RoundedRectangle:
                pos: self.pos
                size: self.size
                radius: [40]
            Color:
                rgba: 0, 0, 0, 0.10
            RoundedRectangle:
                pos: self.x, self.y - 14
                size: self.width, self.height
                radius: [40]

        # --- Heading, App Icon, and Login ---
        BoxLayout:
            orientation: 'horizontal'
            size_hint_y: None
            height: 110
            spacing: 32

            Image:
                source: 'assets/icons/app_icon_72.png'
                size_hint: None, None
                size: 80, 80

            BoxLayout:
                orientation: 'vertical'
                spacing: 10
                Label:
                    text: "Noto.ai"
                    font_size: 44
                    bold: True
                    color: root.text_color
                    size_hint_y: None
                    height: 54
                
                Label:
                    text: "Your Study Toolkit"
                    font_size: 28
                    color: root.text_color
                    bold: False
                    size_hint_y: None
                    height: 40

            Animated3DButton:
                id: login_btn
                text: "Login"
                size_hint_x: 0.35
                font_size: 24
                on_press: app.root.current = 'login'

        BoxLayout:
            orientation: 'horizontal'
            size_hint_y: None
            height: 68
            spacing: 24

            Animated3DDropdownButton:
                id: mode_dropdown
                text: root.ids.mode_dropdown.selected_option if hasattr(root.ids.mode_dropdown, 'selected_option') else "Choose Action"
                size_hint_x: 0.55
                font_size: 24
                disabled: True
                on_selected_option: root.on_mode_selected(self, self.selected_option)

            Animated3DButton:
                id: upload_btn
                text: "Upload File"
                size_hint_x: 0.35
                font_size: 24
                on_press: root.on_upload_button_press(self)

            Animated3DButton:
                id: theme_toggle_btn
                size_hint_x: None
                width: 62
                text: ""
                background_normal: ''
                background_color: 0,0,0,0
                on_press: root.toggle_dark_mode()
                canvas.after:
                    Color:
                        rgba: 1, 1, 1, 1
                    Rectangle:
                        source: 'assets/icons/sun.png' if root.bg_color == [0.96, 0.98, 1, 1] else 'assets/icons/moon.png'
                        pos: self.x + (self.width-40)/2, self.y + (self.height-40)/2
                        size: 40, 40

        BoxLayout:
            id: summary_length_box
            orientation: 'horizontal'
            size_hint_y: None
            height: 54 if root.ask_box_visible else 0
            spacing: 18
            opacity: 1 if root.ask_box_visible else 0
            disabled: not root.ask_box_visible

            Animated3DButton:
                text: "Short"
                on_press: root.set_summary_length("Short")
                background_color: (0.18, 0.7, 0.3, 1) if root.summary_length == "Short" else (0.10, 0.45, 0.80, 1)

            Animated3DButton:
                text: "Medium"
                on_press: root.set_summary_length("Medium")
                background_color: (0.18, 0.7, 0.3, 1) if root.summary_length == "Medium" else (0.10, 0.45, 0.80, 1)

            Animated3DButton:
                text: "Long"
                on_press: root.set_summary_length("Long")
                background_color: (0.18, 0.7, 0.3, 1) if root.summary_length == "Long" else (0.10, 0.45, 0.80, 1)

        Animated3DButton:
            id: execute_btn
            text: "Execute"
            size_hint_y: None
            height: 66
            font_size: 24
            disabled: True
            on_press: root.on_execute_button_press(self)

        Animated3DButton:
            id: copy_btn
            text: "Copy Notes to Clipboard"
            size_hint_y: None
            height: 56
            opacity: 0
            disabled: True
            font_size: 22
            on_press: root.animate_button(self); root.copy_notes_to_clipboard()

        AnchorLayout:
            size_hint_y: None
            height: 54
            anchor_x: 'center'
            LoadingSpinner:
                id: loading_spinner
                size_hint: None, None
                size: 54, 54

        ScrollView:
            id: notes_scroll
            size_hint_y: 1
            do_scroll_x: False
            bar_width: 10
            scroll_type: ['bars', 'content']

            TextInput:
                id: notes_label
                text: ""
                opacity: 1
                size_hint_y: None
                height: self.minimum_height
                font_size: 24
                padding: 24, 24, 24, 24
                background_color: root.bg_color
                foreground_color: root.text_color
                cursor_color: root.accent_color
                text_size: self.width, None
                halign: 'left'
                valign: 'top'
                readonly: True
                multiline: True
                cursor_blink: False

        BoxLayout:
            orientation: 'vertical'
            size_hint_y: None
            height: 190
            opacity: 1 if root.ask_box_visible else 0
            disabled: not root.ask_box_visible
            spacing: 0

            BoxLayout:
                orientation: 'horizontal'
                size_hint_y: None
                height: 62
                spacing: 16
                padding: 0, 0, 0, 0

                TextInput:
                    id: chat_input
                    hint_text: "Ask a question about your notes..."
                    font_size: 20
                    size_hint_x: 0.7
                    multiline: False
                    background_color: root.bg_color
                    foreground_color: root.text_color
                    cursor_color: root.accent_color
                    padding: 18, 12, 18, 12

                Animated3DButton:
                    id: ask_btn
                    text: "Ask"
                    size_hint_x: 0.3
                    font_size: 20
                    on_press: root.on_ask_question()

            ScrollView:
                size_hint_y: 1
                bar_width: 10
                do_scroll_x: False
                do_scroll_y: True

                Label:
                    id: chat_answer
                    text: ""
                    color: root.text_color
                    font_size: 20
                    size_hint_x: 1
                    size_hint_y: None
                    height: self.texture_size[1] + 28 if self.text else 0
                    text_size: self.width, None
                    halign: 'left'
                    valign: 'top'
                    padding_x: 14
